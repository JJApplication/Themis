# Themis GRPC端口管理服务需求文档

## 项目概述

Themis是一个基于GRPC的端口管理服务，用于动态分配和管理系统中应用程序使用的端口。服务提供端口检测、分配、持久化存储等功能，支持多种监听方式。

## 功能需求

### 1. 核心端口管理功能

#### 1.1 端口可用性检测
- **实现方式**: 通过系统调用或第三方库实现，禁止使用命令行方式
- **检测范围**: 支持配置端口范围，默认10000-20000
- **检测机制**: 尝试绑定端口来判断是否可用

#### 1.2 端口分配策略
- **随机分配**: 在配置范围内随机选择可用端口
- **范围限制**: 可通过配置文件设置端口范围
- **冲突避免**: 确保分配的端口未被占用

### 2. 应用端口映射管理

#### 2.1 全局字典维护
- **数据结构**: map[string]int，键为APP名称，值为端口号
- **线程安全**: 支持并发读写操作
- **内存管理**: 运行时维护完整映射关系

#### 2.2 持久化存储
- **存储格式**: JSON文件格式
- **文件位置**: 可配置持久化文件路径
- **同步机制**: 定时自动同步到文件
- **启动加载**: 服务启动时从JSON文件加载已有映射

### 3. GRPC服务接口

#### 3.1 GetRandomPort
- **功能**: 获取一个随机可用端口
- **输入**: 无参数
- **输出**: 端口号(int32) + 错误信息

#### 3.2 GetRandomPorts
- **功能**: 获取N个随机可用端口
- **输入**: count(int32) - 需要的端口数量
- **输出**: 端口数组([]int32) + 错误信息

#### 3.3 GetAppPort
- **功能**: 获取指定APP的端口
- **输入**: appName(string) - 应用名称
- **输出**: 端口号(int32) + 错误信息
- **逻辑**: 从全局字典查找，不存在则返回错误

#### 3.4 SetAppPort
- **功能**: 设置指定APP的端口
- **输入**: appName(string), port(int32)
- **输出**: 成功标识(bool) + 错误信息
- **逻辑**: 更新全局字典并触发持久化

#### 3.5 QuickSetAppPort
- **功能**: 快速设置APP端口
- **输入**: appName(string)
- **输出**: 端口号(int32) + 错误信息
- **逻辑**: 存在则返回现有端口，不存在则分配新端口

#### 3.6 DeleteAppPort
- **功能**: 删除指定APP的端口信息
- **输入**: appName(string)
- **输出**: 成功标识(bool) + 错误信息
- **逻辑**: 从全局字典删除并立即刷新JSON文件

### 4. 服务配置

#### 4.1 监听配置
- **默认方式**: Unix Domain Socket - /var/run/Themis.sock
- **可选方式**: TCP监听 - 支持配置HOST和端口
- **配置文件**: 支持通过配置文件切换监听方式

#### 4.2 端口范围配置
- **默认范围**: 10000-20000
- **配置方式**: 通过配置文件设置min_port和max_port

#### 4.3 持久化配置
- **同步间隔**: 可配置定时同步时间间隔
- **文件路径**: 可配置JSON持久化文件路径
- **默认文件**: ./ports.json

## 技术规范

### 1. 开发环境
- **语言**: Go 1.19+
- **GRPC**: 使用Protocol Buffers定义服务
- **配置格式**: JSON格式统一配置
- **目标系统**: Linux系统

### 2. 项目结构
```
Themis/
├── proto/              # Protocol Buffers定义
│   └── port_service.proto
├── internal/           # 内部实现
│   ├── config/        # 配置管理
│   ├── port/          # 端口管理核心逻辑
│   └── storage/       # 持久化存储
├── cmd/               # 主程序入口
│   └── server/
├── configs/           # 配置文件
├── go.mod
├── go.sum
└── README.md
```

### 3. 依赖库
- **GRPC**: google.golang.org/grpc
- **Protocol Buffers**: google.golang.org/protobuf
- **配置管理**: 标准库encoding/json
- **并发安全**: sync包

### 4. 错误处理
- **GRPC错误码**: 使用标准GRPC状态码
- **错误信息**: 提供详细的中文错误描述
- **日志记录**: 记录关键操作和错误信息

### 5. 性能要求
- **并发支持**: 支持多客户端并发访问
- **响应时间**: 端口分配操作应在100ms内完成
- **内存使用**: 合理控制内存占用

## 安全考虑

### 1. 权限控制
- **UDS权限**: Unix Domain Socket文件权限设置
- **端口范围**: 限制在非特权端口范围内

### 2. 数据保护
- **文件权限**: JSON持久化文件适当权限设置
- **并发安全**: 防止数据竞争和不一致

## 部署要求

### 1. 系统要求
- **操作系统**: Linux
- **权限**: 需要绑定端口的权限
- **磁盘空间**: 用于JSON文件存储

### 2. 配置文件
- **位置**: ./config.json
- **格式**: JSON格式
- **必需配置**: 端口范围、监听地址、持久化设置

## 测试策略

注意：根据项目规范，不生成测试文件，但需要确保代码质量：
- **功能验证**: 手动验证各接口功能
- **并发测试**: 验证多客户端并发访问
- **持久化测试**: 验证数据持久化和恢复
- **错误处理**: 验证各种异常情况处理

## 交付物

1. **源代码**: 完整的Go源代码
2. **配置文件**: 默认配置文件模板
3. **文档**: README和使用说明
4. **构建脚本**: Makefile或构建脚本
5. **部署指南**: 部署和运行说明